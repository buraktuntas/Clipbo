package com.bt.clipbo.presentation.ui.settings

import android.content.Intent
import android.net.Uri
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.bt.clipbo.presentation.ui.components.BackupProgressDialog

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SettingsScreen(
    viewModel: SettingsViewModel = hiltViewModel(),
    onNavigateBack: () -> Unit = {}
) {
    val uiState by viewModel.uiState.collectAsState()
    val context = LocalContext.current

    // File picker launchers
    val exportLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.CreateDocument("application/json")
    ) { uri ->
        uri?.let { viewModel.exportBackup(it) }
    }

    val importLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.OpenDocument()
    ) { uri ->
        uri?.let { viewModel.importBackup(it) }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("‚öôÔ∏è Ayarlar") },
                navigationIcon = {
                    IconButton(onClick = onNavigateBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Geri")
                    }
                },
                colors = TopAppBarDefaults.topAppBarColors(
                    containerColor = MaterialTheme.colorScheme.primaryContainer,
                    titleContentColor = MaterialTheme.colorScheme.onPrimaryContainer
                )
            )
        }
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
                .verticalScroll(rememberScrollState())
                .padding(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {

            // Genel Ayarlar
            SettingsSection(title = "üéõÔ∏è Genel Ayarlar") {
                SettingsItem(
                    title = "Koyu Tema",
                    description = "Gece modu i√ßin koyu renk temasƒ± kullan",
                    icon = Icons.Default.DarkMode,
                    trailing = {
                        Switch(
                            checked = uiState.isDarkTheme,
                            onCheckedChange = { viewModel.toggleDarkTheme() }
                        )
                    }
                )

                SettingsItem(
                    title = "Otomatik Servis Ba≈ülatma",
                    description = "Uygulama a√ßƒ±ldƒ±ƒüƒ±nda clipboard servisini otomatik ba≈ülat",
                    icon = Icons.Default.PlayArrow,
                    trailing = {
                        Switch(
                            checked = uiState.autoStartService,
                            onCheckedChange = { viewModel.toggleAutoStartService() }
                        )
                    }
                )

                SettingsItem(
                    title = "Maksimum Ge√ßmi≈ü √ñƒüesi",
                    description = "${uiState.maxHistoryItems} √∂ƒüe saklanacak",
                    icon = Icons.Default.Storage,
                    onClick = { viewModel.showMaxItemsDialog() },
                    trailing = {
                        Icon(
                            Icons.Default.ChevronRight,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                )
            }

            // G√ºvenlik Ayarlarƒ±
            SettingsSection(title = "üîí G√ºvenlik") {
                SettingsItem(
                    title = "G√ºvenli Mod",
                    description = "Hassas verileri otomatik algƒ±la ve ≈üifrele",
                    icon = Icons.Default.Security,
                    trailing = {
                        Switch(
                            checked = uiState.enableSecureMode,
                            onCheckedChange = { viewModel.toggleSecureMode() }
                        )
                    }
                )

                SettingsItem(
                    title = "Biyometrik Doƒürulama",
                    description = "G√ºvenli pano i√ßin parmak izi/y√ºz tanƒ±ma",
                    icon = Icons.Default.Fingerprint,
                    onClick = { /* Biometric ayarlarƒ± */ },
                    trailing = {
                        Icon(
                            Icons.Default.ChevronRight,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                )
            }

            // Veri Y√∂netimi - BACKUP/RESTORE B√ñL√úM√ú
            SettingsSection(title = "üíæ Veri Y√∂netimi") {
                SettingsItem(
                    title = "Verileri Dƒ±≈üa Aktar",
                    description = "Clipboard ge√ßmi≈üini JSON olarak dƒ±≈üa aktar",
                    icon = Icons.Default.FileUpload,
                    onClick = {
                        exportLauncher.launch("clipbo_backup_${System.currentTimeMillis()}.json")
                    },
                    trailing = {
                        Icon(
                            Icons.Default.ChevronRight,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.primary
                        )
                    }
                )

                SettingsItem(
                    title = "Verileri ƒ∞√ße Aktar",
                    description = "√ñnceki yedekten geri y√ºkle",
                    icon = Icons.Default.FileDownload,
                    onClick = {
                        importLauncher.launch(arrayOf("application/json", "*/*"))
                    },
                    trailing = {
                        Icon(
                            Icons.Default.ChevronRight,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.primary
                        )
                    }
                )

                SettingsItem(
                    title = "Yerel Yedekler",
                    description = "Otomatik olu≈üturulan yedekleri g√∂r√ºnt√ºle",
                    icon = Icons.Default.Folder,
                    onClick = { viewModel.showLocalBackupsDialog() },
                    trailing = {
                        Row(
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            if (uiState.localBackupCount > 0) {
                                Text(
                                    text = "${uiState.localBackupCount}",
                                    style = MaterialTheme.typography.labelMedium,
                                    color = MaterialTheme.colorScheme.primary
                                )
                                Spacer(modifier = Modifier.width(4.dp))
                            }
                            Icon(
                                Icons.Default.ChevronRight,
                                contentDescription = null,
                                tint = MaterialTheme.colorScheme.onSurfaceVariant
                            )
                        }
                    }
                )

                SettingsItem(
                    title = "Otomatik Yedekleme",
                    description = if (uiState.autoBackupEnabled) "G√ºnl√ºk otomatik yedek olu≈üturuluyor"
                    else "Otomatik yedekleme kapalƒ±",
                    icon = Icons.Default.Schedule,
                    trailing = {
                        Switch(
                            checked = uiState.autoBackupEnabled,
                            onCheckedChange = { viewModel.toggleAutoBackup() }
                        )
                    }
                )

                Divider(modifier = Modifier.padding(vertical = 8.dp))

                SettingsItem(
                    title = "T√ºm Verileri Sil",
                    description = "T√ºm clipboard ge√ßmi≈üini kalƒ±cƒ± olarak sil",
                    icon = Icons.Default.DeleteForever,
                    onClick = { viewModel.showClearAllDataDialog() },
                    textColor = MaterialTheme.colorScheme.error,
                    trailing = {
                        Icon(
                            Icons.Default.Warning,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.error
                        )
                    }
                )
            }

            // Premium
            SettingsSection(title = "‚≠ê Premium") {
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.tertiaryContainer
                    )
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp)
                    ) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Text(
                                text = "‚≠ê",
                                style = MaterialTheme.typography.headlineMedium
                            )

                            Spacer(modifier = Modifier.width(12.dp))

                            Column(
                                modifier = Modifier.weight(1f)
                            ) {
                                Text(
                                    text = "Premium'a Ge√ßin",
                                    style = MaterialTheme.typography.titleMedium,
                                    color = MaterialTheme.colorScheme.onTertiaryContainer
                                )

                                Text(
                                    text = "Sƒ±nƒ±rsƒ±z etiket, cloud sync ve daha fazlasƒ±",
                                    style = MaterialTheme.typography.bodyMedium,
                                    color = MaterialTheme.colorScheme.onTertiaryContainer
                                )
                            }
                        }

                        Spacer(modifier = Modifier.height(12.dp))

                        Button(
                            onClick = { /* Premium satƒ±n alma */ },
                            modifier = Modifier.fillMaxWidth()
                        ) {
                            Text("‚Ç∫40 - Premium Satƒ±n Al")
                        }
                    }
                }
            }

            // Hakkƒ±nda
            SettingsSection(title = "‚ÑπÔ∏è Hakkƒ±nda") {
                SettingsItem(
                    title = "S√ºr√ºm",
                    description = "Clipbo v${uiState.appVersion}",
                    icon = Icons.Default.Info,
                    onClick = { /* Version info */ }
                )

                SettingsItem(
                    title = "Gizlilik Politikasƒ±",
                    description = "Verilerinizi nasƒ±l koruduƒüumuzu √∂ƒürenin",
                    icon = Icons.Default.PrivacyTip,
                    onClick = {
                        val intent = Intent(Intent.ACTION_VIEW, Uri.parse("https://clipbo.app/privacy"))
                        context.startActivity(intent)
                    },
                    trailing = {
                        Icon(
                            Icons.Default.OpenInNew,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                )

                SettingsItem(
                    title = "Kullanƒ±m Ko≈üullarƒ±",
                    description = "Hizmet ≈üartlarƒ±mƒ±zƒ± inceleyin",
                    icon = Icons.Default.Gavel,
                    onClick = {
                        val intent = Intent(Intent.ACTION_VIEW, Uri.parse("https://clipbo.app/terms"))
                        context.startActivity(intent)
                    },
                    trailing = {
                        Icon(
                            Icons.Default.OpenInNew,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                )

                SettingsItem(
                    title = "Destek",
                    description = "Yardƒ±m almak i√ßin bize yazƒ±n",
                    icon = Icons.Default.Support,
                    onClick = {
                        val intent = Intent(Intent.ACTION_SENDTO).apply {
                            data = Uri.parse("mailto:support@clipbo.app")
                            putExtra(Intent.EXTRA_SUBJECT, "Clipbo Destek")
                        }
                        context.startActivity(intent)
                    },
                    trailing = {
                        Icon(
                            Icons.Default.OpenInNew,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                )

                SettingsItem(
                    title = "Uygulamamƒ±zƒ± Deƒüerlendirin",
                    description = "Google Play'de 5 yƒ±ldƒ±z verin",
                    icon = Icons.Default.Star,
                    onClick = {
                        val intent = Intent(Intent.ACTION_VIEW, Uri.parse("market://details?id=${context.packageName}"))
                        context.startActivity(intent)
                    },
                    trailing = {
                        Icon(
                            Icons.Default.OpenInNew,
                            contentDescription = null,
                            tint = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                )
            }
        }
    }

    // Dialogs
    if (uiState.showMaxItemsDialog) {
        MaxItemsDialog(
            currentValue = uiState.maxHistoryItems,
            onDismiss = { viewModel.hideMaxItemsDialog() },
            onConfirm = { newValue ->
                viewModel.setMaxHistoryItems(newValue)
                viewModel.hideMaxItemsDialog()
            }
        )
    }

    if (uiState.showBackupProgress) {
        BackupProgressDialog(
            backupRestoreManager = viewModel.getBackupRestoreManager(),
            onDismiss = { viewModel.hideBackupProgress() }
        )
    }

    if (uiState.showLocalBackupsDialog) {
        LocalBackupsDialog(
            localBackups = uiState.localBackups,
            onDismiss = { viewModel.hideLocalBackupsDialog() },
            onRestoreBackup = { backupInfo ->
                viewModel.restoreLocalBackup(backupInfo)
            },
            onDeleteBackup = { backupInfo ->
                viewModel.deleteLocalBackup(backupInfo)
            }
        )
    }

    if (uiState.showClearAllDataDialog) {
        AlertDialog(
            onDismissRequest = { viewModel.hideClearAllDataDialog() },
            icon = { Icon(Icons.Default.Warning, contentDescription = null) },
            title = { Text("‚ö†Ô∏è T√ºm Verileri Sil") },
            text = {
                Text(
                    "Bu i≈ülem geri alƒ±namaz!\n\nT√ºm clipboard ge√ßmi≈üi, etiketler ve ayarlar kalƒ±cƒ± olarak silinecek.\n\nDevam etmek istediƒüinizden emin misiniz?"
                )
            },
            confirmButton = {
                Button(
                    onClick = {
                        viewModel.clearAllData()
                        viewModel.hideClearAllDataDialog()
                    },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = MaterialTheme.colorScheme.error
                    )
                ) {
                    Text("Evet, T√ºm√ºn√º Sil")
                }
            },
            dismissButton = {
                TextButton(onClick = { viewModel.hideClearAllDataDialog() }) {
                    Text("ƒ∞ptal")
                }
            }
        )
    }

    // Toast messages
    LaunchedEffect(uiState.toastMessage) {
        uiState.toastMessage?.let { message ->
            Toast.makeText(context, message, Toast.LENGTH_LONG).show()
            viewModel.clearToastMessage()
        }
    }
}