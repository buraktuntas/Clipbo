package com.bt.clipbo.utils

import android.Manifest
import android.accessibilityservice.AccessibilityServiceInfo
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.provider.Settings
import android.view.accessibility.AccessibilityManager
import androidx.core.content.ContextCompat
import com.bt.clipbo.data.service.ClipboAccessibilityService
import dagger.hilt.android.qualifiers.ApplicationContext
import javax.inject.Inject
import javax.inject.Singleton

@Singleton
class PermissionHelper
    @Inject
    constructor(
        @ApplicationContext private val context: Context,
    ) {
        data class PermissionStatus(
            val isGranted: Boolean,
            val shouldShowRationale: Boolean = false,
            val message: String = "",
            val actionRequired: String = "",
        )

        companion object {
            const val REQUEST_OVERLAY_PERMISSION = 1001
            const val REQUEST_ACCESSIBILITY_PERMISSION = 1002
            const val REQUEST_NOTIFICATION_PERMISSION = 1003
        }

        /**
         * Bildirim izni kontrol√º
         */
        fun hasNotificationPermission(): PermissionStatus {
            return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                val isGranted =
                    ContextCompat.checkSelfPermission(
                        context,
                        Manifest.permission.POST_NOTIFICATIONS,
                    ) == PackageManager.PERMISSION_GRANTED

                PermissionStatus(
                    isGranted = isGranted,
                    message = if (isGranted) "Bildirim izni verildi" else "Bildirim izni gerekli",
                    actionRequired = if (!isGranted) "POST_NOTIFICATIONS izni gerekli" else "",
                )
            } else {
                PermissionStatus(
                    isGranted = true,
                    message = "Android 13 √∂ncesi otomatik izinli",
                )
            }
        }

        /**
         * Overlay (Diƒüer uygulamalarƒ±n √ºzerine √ßizme) izni kontrol√º
         */
        fun hasOverlayPermission(): PermissionStatus {
            return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                val isGranted = Settings.canDrawOverlays(context)
                PermissionStatus(
                    isGranted = isGranted,
                    message = if (isGranted) "Overlay izni verildi" else "Overlay izni clipboard dinleme i√ßin gerekli",
                    actionRequired = if (!isGranted) "Diƒüer uygulamalarƒ±n √ºzerine √ßizme izni gerekli" else "",
                )
            } else {
                PermissionStatus(
                    isGranted = true,
                    message = "Android 6.0 √∂ncesi otomatik izinli",
                )
            }
        }

        /**
         * Eri≈üilebilirlik servisi izni kontrol√º
         */
        fun hasAccessibilityPermission(): PermissionStatus {
            val accessibilityManager = context.getSystemService(Context.ACCESSIBILITY_SERVICE) as AccessibilityManager
            val enabledServices = accessibilityManager.getEnabledAccessibilityServiceList(AccessibilityServiceInfo.FEEDBACK_ALL_MASK)

            val isGranted =
                enabledServices.any { service ->
                    service.resolveInfo.serviceInfo.packageName == context.packageName &&
                        service.resolveInfo.serviceInfo.name == ClipboAccessibilityService::class.java.name
                }

            return PermissionStatus(
                isGranted = isGranted,
                message = if (isGranted) "Eri≈üilebilirlik izni verildi" else "Clipboard eri≈üimi i√ßin eri≈üilebilirlik izni gerekli",
                actionRequired = if (!isGranted) "Eri≈üilebilirlik ayarlarƒ±ndan Clipbo'yu etkinle≈ütirin" else "",
            )
        }

        /**
         * T√ºm izinlerin durumunu d√∂nd√ºr√ºr
         */
        fun getAllPermissionStatuses(): Map<String, PermissionStatus> {
            return mapOf(
                "notification" to hasNotificationPermission(),
                "overlay" to hasOverlayPermission(),
                "accessibility" to hasAccessibilityPermission(),
            )
        }

        /**
         * Bildirim izni intent'i (Android 13+)
         */
        fun getNotificationPermissionIntent(): Intent? {
            return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                // Bu intent MainActivity'de ActivityResultContracts.RequestPermission() ile kullanƒ±lƒ±r
                null // ActivityResultLauncher gerekli
            } else {
                null
            }
        }

        /**
         * Overlay izni i√ßin ayarlar intent'i
         */
        fun getOverlayPermissionIntent(): Intent? {
            return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                Intent(
                    Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                    Uri.parse("package:${context.packageName}"),
                ).apply {
                    addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                }
            } else {
                null
            }
        }

        /**
         * Eri≈üilebilirlik ayarlarƒ± intent'i
         */
        fun getAccessibilityPermissionIntent(): Intent {
            return Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS).apply {
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
        }

        /**
         * Uygulama detay ayarlarƒ± intent'i
         */
        fun getAppSettingsIntent(): Intent {
            return Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
                data = Uri.fromParts("package", context.packageName, null)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
        }

        /**
         * Runtime'da istenmesi gereken izinler listesi
         */
        fun getRequiredRuntimePermissions(): List<String> {
            val permissions = mutableListOf<String>()

            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                permissions.add(Manifest.permission.POST_NOTIFICATIONS)
            }

            return permissions
        }

        /**
         * T√ºm izinler verilmi≈ü mi kontrol et
         */
        fun areAllPermissionsGranted(): Boolean {
            val statuses = getAllPermissionStatuses()
            return statuses.values.all { it.isGranted }
        }

        /**
         * Eksik izinlerin listesini d√∂nd√ºr√ºr
         */
        fun getMissingPermissions(): List<String> {
            val statuses = getAllPermissionStatuses()
            return statuses.filter { !it.value.isGranted }.keys.toList()
        }

        /**
         * ƒ∞zin durumu a√ßƒ±klamasƒ±
         */
        fun getPermissionExplanation(permissionType: String): String {
            return when (permissionType) {
                "notification" ->
                    """
                    üì¢ Bildirim ƒ∞zni
                    
                    Bu izin Clipbo'nun arka planda √ßalƒ±≈üƒ±rken size bildirim g√∂sterebilmesi i√ßin gereklidir.
                    
                    Kullanƒ±m alanlarƒ±:
                    ‚Ä¢ Clipboard servisi aktif durumu bildirimi
                    ‚Ä¢ Yeni kopyalanan i√ßerik bildirimleri
                    ‚Ä¢ Hata durumu uyarƒ±larƒ±
                    
                    Android 13+ cihazlarda zorunludur.
                    """.trimIndent()

                "overlay" ->
                    """
                    üîÑ Overlay ƒ∞zni
                    
                    Bu izin Clipbo'nun diƒüer uygulamalarƒ±n √ºzerine k√º√ß√ºk pencereler √ßizebilmesi i√ßin gereklidir.
                    
                    Kullanƒ±m alanlarƒ±:
                    ‚Ä¢ Clipboard ge√ßmi≈üini hƒ±zlƒ± eri≈üim penceresi
                    ‚Ä¢ Kopyalanan i√ßeriƒüi anƒ±nda g√∂sterme
                    ‚Ä¢ Floating widget desteƒüi
                    
                    Clipboard izleme i√ßin √∂nemlidir.
                    """.trimIndent()

                "accessibility" ->
                    """
                    ‚ôø Eri≈üilebilirlik ƒ∞zni
                    
                    Bu izin Clipbo'nun sistem clipboard'una eri≈üebilmesi i√ßin gereklidir.
                    
                    Kullanƒ±m alanlarƒ±:
                    ‚Ä¢ Kopyalanan metinleri otomatik yakalama
                    ‚Ä¢ Clipboard deƒüi≈üikliklerini izleme
                    ‚Ä¢ Uygulama dƒ±≈üƒ± clipboard eri≈üimi
                    
                    Ana fonksiyon i√ßin zorunludur.
                    
                    ‚ö†Ô∏è Bu izin sadece clipboard eri≈üimi i√ßin kullanƒ±lƒ±r, 
                    diƒüer uygulamalardaki verilerinize eri≈ümez.
                    """.trimIndent()

                else -> "Bilinmeyen izin t√ºr√º"
            }
        }

        /**
         * ƒ∞zin verme adƒ±mlarƒ± rehberi
         */
        fun getPermissionSteps(permissionType: String): List<String> {
            return when (permissionType) {
                "notification" ->
                    listOf(
                        "1. 'ƒ∞zin Ver' butonuna basƒ±n",
                        "2. A√ßƒ±lan pencerede 'ƒ∞zin Ver'i se√ßin",
                        "3. Clipbo'ya d√∂n√ºn",
                    )

                "overlay" ->
                    listOf(
                        "1. 'Ayarlara Git' butonuna basƒ±n",
                        "2. 'Diƒüer uygulamalarƒ±n √ºzerine √ßizme' se√ßeneƒüini bulun",
                        "3. Clipbo'yu listeden bulun ve etkinle≈ütirin",
                        "4. Clipbo'ya d√∂n√ºn",
                    )

                "accessibility" ->
                    listOf(
                        "1. 'Eri≈üilebilirlik Ayarlarƒ±'na gidin",
                        "2. 'ƒ∞ndirilen uygulamalar' b√∂l√ºm√ºn√º bulun",
                        "3. 'Clipbo' servisini bulun ve dokunun",
                        "4. 'Kullan' d√ºƒümesini etkinle≈ütirin",
                        "5. Uyarƒ±yƒ± onaylayƒ±n ve Clipbo'ya d√∂n√ºn",
                    )

                else -> listOf("Bilinmeyen izin t√ºr√º")
            }
        }

        /**
         * ƒ∞zin durumu emoji'si
         */
        fun getPermissionStatusEmoji(permissionType: String): String {
            val status =
                when (permissionType) {
                    "notification" -> hasNotificationPermission()
                    "overlay" -> hasOverlayPermission()
                    "accessibility" -> hasAccessibilityPermission()
                    else -> PermissionStatus(false)
                }

            return if (status.isGranted) "‚úÖ" else "‚ùå"
        }

        /**
         * Kritik izinler (uygulama √ßalƒ±≈ümasƒ± i√ßin gerekli)
         */
        fun getCriticalPermissions(): List<String> {
            return listOf("accessibility") // Clipboard eri≈üimi i√ßin kritik
        }

        /**
         * Opsiyonel izinler (uygulama √ßalƒ±≈üabilir ama √∂zellikler kƒ±sƒ±tlƒ±)
         */
        fun getOptionalPermissions(): List<String> {
            return listOf("notification", "overlay")
        }

        /**
         * ƒ∞zin durumu raporu
         */
        fun generatePermissionReport(): String {
            val statuses = getAllPermissionStatuses()
            val report = StringBuilder()

            report.appendLine("üìã Clipbo ƒ∞zin Durumu Raporu")
            report.appendLine("=" * 40)

            statuses.forEach { (type, status) ->
                val emoji = getPermissionStatusEmoji(type)
                val typeName =
                    when (type) {
                        "notification" -> "Bildirim"
                        "overlay" -> "Overlay"
                        "accessibility" -> "Eri≈üilebilirlik"
                        else -> type
                    }

                report.appendLine("$emoji $typeName: ${if (status.isGranted) "VERƒ∞LDƒ∞" else "EKSƒ∞K"}")
                if (!status.isGranted && status.actionRequired.isNotEmpty()) {
                    report.appendLine("   ‚Üí ${status.actionRequired}")
                }
            }

            report.appendLine("=" * 40)
            val grantedCount = statuses.values.count { it.isGranted }
            val totalCount = statuses.size
            report.appendLine("Toplam: $grantedCount/$totalCount izin verildi")

            if (areAllPermissionsGranted()) {
                report.appendLine("üéâ T√ºm izinler tamam! Clipbo kullanƒ±ma hazƒ±r.")
            } else {
                report.appendLine("‚ö†Ô∏è Eksik izinler var. Tam fonksiyonalite i√ßin tamamlayƒ±n.")
            }

            return report.toString()
        }
    }

// Extension function for String repeat (Kotlin doesn't have it built-in)
private operator fun String.times(count: Int): String {
    return this.repeat(count)
}
